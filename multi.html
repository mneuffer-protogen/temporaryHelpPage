<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Detailed 24-Terminal Battery Sim</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        h3 { margin-top: 15px; color: #aaa; }
        .hint { font-size: 0.8em; color: #666; margin-bottom: 20px; }

        /* --- RACK LAYOUT --- */
        .rack {
            display: flex;
            gap: 20px;
            padding: 30px;
            background: #1e1e1e;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        /* --- BATTERY BLOCK (Contains 3 Cells) --- */
        .battery-block {
            width: 140px;
            height: 180px;
            background: linear-gradient(to bottom, #0055aa 50px, #ddd 50px);
            border-radius: 4px;
            position: relative;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.6);
            display: flex;
            justify-content: space-evenly;
            padding-top: 10px;
            border: 1px solid #333;
        }

        .battery-block::after {
            content: attr(data-name);
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            color: #333;
            font-weight: bold;
        }

        /* --- INDIVIDUAL CELL (Visual grouping) --- */
        .cell-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 33%;
            position: relative;
        }
        
        /* Yellow Vent Cap */
        .vent-cap {
            width: 20px; height: 20px;
            background: #eebb00; /* Yellow cap */
            border-radius: 50%;
            margin-bottom: 5px;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            border: 1px solid #bba000;
        }

        /* --- TERMINALS --- */
        .terminal {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #555;
            margin: 2px 0;
            cursor: crosshair;
            transition: transform 0.1s;
            position: relative;
            z-index: 10;
        }

        .terminal:hover { transform: scale(1.3); border-color: #fff; }
        .terminal.pos { background: #d32f2f; border-color: #ff6666; }
        .terminal.neg { background: #212121; border-color: #666; }

        /* --- JUMPERS (Visual Straps) --- */
        .strap-internal {
            position: absolute;
            height: 8px;
            background: #888;
            border: 1px solid #555;
            z-index: 5;
            top: 45px; /* Aligns with terminals */
            transform-origin: left center;
        }
        
        .cable-external {
            position: absolute;
            height: 8px; /* Thicker cable */
            background: #222; /* Black cable insulation */
            border: 1px solid #000;
            z-index: 6;
            top: 35px; /* Loops higher */
            border-radius: 4px;
        }

        /* --- MULTIMETER --- */
        .multimeter-case {
            width: 220px;
            background: #fbc02d;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 4px solid #333;
        }

        .lcd-screen {
            width: 90%;
            height: 50px;
            background: #aabba0;
            font-family: 'Courier New', monospace;
            font-size: 28px;
            color: #111;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            border: 2px solid #555;
            border-radius: 4px;
            margin-bottom: 20px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
        }

        /* --- DRAGGABLE PROBES --- */
        .probe {
            position: absolute;
            width: 14px;
            height: 80px;
            cursor: grab;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            filter: drop-shadow(3px 3px 3px rgba(0,0,0,0.5));
        }
        .probe:active { cursor: grabbing; }

        .probe-tip { width: 4px; height: 25px; background: silver; border-radius: 1px; }
        .probe-body { width: 14px; height: 55px; border-radius: 3px; }
        
        .probe.red .probe-body { background: #d32f2f; }
        .probe.black .probe-body { background: #212121; }

        /* Wires SVG */
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 900; }
    </style>
</head>
<body>

    <h3>UE5 Battery Sim Logic Check</h3>
    <div class="hint">12 Cells Total (4 Blocks x 3 Cells). Measure across any 2 points.</div>

    <div class="rack" id="rackContainer">
        </div>

    <div class="multimeter-case" id="meter">
        <div class="lcd-screen" id="display">0.00 V</div>
    </div>

    <div id="probeRed" class="probe red" style="top: 500px; left: calc(50% + 40px);">
        <div class="probe-tip"></div><div class="probe-body"></div>
    </div>
    <div id="probeBlack" class="probe black" style="top: 500px; left: calc(50% - 40px);">
        <div class="probe-tip"></div><div class="probe-body"></div>
    </div>

    <svg>
        <path id="wireRed" stroke="#d32f2f" stroke-width="3" fill="none" />
        <path id="wireBlack" stroke="#333" stroke-width="3" fill="none" />
    </svg>

    <script>
        // --- CONFIGURATION ---
        // 4 Batteries, 3 Cells each.
        // Voltage per cell (Healthy state)
        const CELL_VOLTAGE = 2.05; 
        const NUM_BATTERIES = 4;
        const CELLS_PER_BATTERY = 3;

        // We build the rack from RIGHT (0V) to LEFT (Max Voltage) visually 
        // to match typical "Series String" diagrams, or Left-to-Right.
        // Let's do Left-to-Right = High-to-Low for this visual.
        // Actually, standard rack wiring zigs zags. Let's do a simple linear series.
        // Bat 1 (Left) is most positive. Bat 4 (Right) is Ground.

        const rackEl = document.getElementById('rackContainer');
        const terminals = []; // Store references for collision

        function buildRack() {
            // Total voltage starts high and drops as we go right
            // Or starts 0 at right and goes up. Let's calculate Potentials.
            
            // We have 12 cells total. 
            // Cell 0 (Far Right, Bat 4) -> Neg=0V, Pos=2.05V
            // Cell 11 (Far Left, Bat 1) -> Neg=22.55V, Pos=24.6V

            let globalCellIndex = 0; // 0 to 11

            // Loop Batteries (Reverse order visually so Bat 1 is Left)
            for (let b = NUM_BATTERIES - 1; b >= 0; b--) {
                const batDiv = document.createElement('div');
                batDiv.className = 'battery-block';
                batDiv.setAttribute('data-name', `Bat ${b+1}`);
                
                // Inside each battery, 3 cells.
                // If it's a standard block, terminals are usually arranged:
                // Pos [Cell 3] Neg -- Pos [Cell 2] Neg -- Pos [Cell 1] Neg
                // Let's model them simply side-by-side.
                
                for (let c = CELLS_PER_BATTERY - 1; c >= 0; c--) {
                    // Calculate Global Cell ID (0 is system ground cell)
                    // If b=0 (Bat1), c=2 -> This is the highest cell
                    let absoluteCellID = (b * CELLS_PER_BATTERY) + c;
                    
                    // Potentials for this specific cell
                    let negPot = absoluteCellID * CELL_VOLTAGE;
                    let posPot = (absoluteCellID + 1) * CELL_VOLTAGE;

                    const cellGroup = document.createElement('div');
                    cellGroup.className = 'cell-group';

                    // Vent Cap
                    const cap = document.createElement('div');
                    cap.className = 'vent-cap';

                    // Positive Terminal
                    const termPos = document.createElement('div');
                    termPos.className = 'terminal pos';
                    termPos.dataset.potential = posPot.toFixed(2);
                    termPos.title = `Cell ${absoluteCellID+1} Pos: ${posPot.toFixed(2)}V`;

                    // Negative Terminal
                    const termNeg = document.createElement('div');
                    termNeg.className = 'terminal neg';
                    termNeg.dataset.potential = negPot.toFixed(2);
                    termNeg.title = `Cell ${absoluteCellID+1} Neg: ${negPot.toFixed(2)}V`;

                    cellGroup.appendChild(cap);
                    cellGroup.appendChild(termPos);
                    cellGroup.appendChild(termNeg);
                    batDiv.appendChild(cellGroup);

                    // Add visual straps? 
                    // We need to connect THIS Neg to PREVIOUS Pos visually.
                    // This logic is tricky in DOM, simpler to just calculate potentials correctly.
                    // The "jumpers" are implied by the math: 
                    // Bat 4 Cell 2 Neg (2.05V) is same potential as Bat 4 Cell 1 Pos (2.05V).
                    // In simulation, touching either gives same result.
                }
                rackEl.appendChild(batDiv);
            }
        }

        buildRack();

        // --- INTERACTION LOGIC (Same as before, updated for accurate potentials) ---
        const probeRed = { el: document.getElementById('probeRed'), x: 0, y: 0, val: null };
        const probeBlack = { el: document.getElementById('probeBlack'), x: 0, y: 0, val: null };
        const display = document.getElementById('display');
        const wireRed = document.getElementById('wireRed');
        const wireBlack = document.getElementById('wireBlack');
        const meterRect = document.getElementById('meter').getBoundingClientRect();

        let activeProbe = null;
        let offset = {x:0, y:0};

        // Initialize drag
        [probeRed, probeBlack].forEach(p => {
            p.el.addEventListener('mousedown', (e) => startDrag(e, p));
            p.el.addEventListener('touchstart', (e) => startDrag(e, p), {passive:false});
        });

        function startDrag(e, probeObj) {
            e.preventDefault();
            activeProbe = probeObj;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = probeObj.el.getBoundingClientRect();
            offset.x = clientX - rect.left;
            offset.y = clientY - rect.top;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, {passive:false});
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function drag(e) {
            if(!activeProbe) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = clientX - offset.x;
            const y = clientY - offset.y;
            
            activeProbe.el.style.left = x + 'px';
            activeProbe.el.style.top = y + 'px';
            
            checkCollision(activeProbe);
            updateWires();
        }

        function endDrag() {
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
            activeProbe = null;
        }

        function checkCollision(probeObj) {
            // Hotspot is bottom-center of tip
            const rect = probeObj.el.getBoundingClientRect();
            const tipX = rect.left + rect.width/2;
            const tipY = rect.bottom; 

            // Find intersecting terminal
            const allTerms = document.querySelectorAll('.terminal');
            let hit = false;
            
            allTerms.forEach(term => {
                const tRect = term.getBoundingClientRect();
                if(tipX >= tRect.left && tipX <= tRect.right &&
                   tipY >= tRect.top && tipY <= tRect.bottom) {
                    
                    probeObj.val = parseFloat(term.dataset.potential);
                    term.style.borderColor = "white";
                    hit = true;
                } else {
                    // Reset color
                    if(term.classList.contains('pos')) term.style.borderColor = "#ff6666";
                    else term.style.borderColor = "#666";
                }
            });

            if(!hit) probeObj.val = null;
            updateDisplay();
        }

        function updateDisplay() {
            if(probeRed.val !== null && probeBlack.val !== null) {
                let v = probeRed.val - probeBlack.val;
                // Add tiny random noise for realism?
                // v += (Math.random() * 0.02); 
                display.innerText = v.toFixed(2) + " V";
            } else {
                display.innerText = "0.00 V";
            }
        }

        function updateWires() {
            // Draw curved SVG path from meter to probe handle
            drawPath(probeRed.el, meterRect.left + 160, meterRect.bottom - 10, wireRed);
            drawPath(probeBlack.el, meterRect.left + 60, meterRect.bottom - 10, wireBlack);
        }

        function drawPath(probeEl, startX, startY, pathEl) {
            const r = probeEl.getBoundingClientRect();
            const endX = r.left + r.width/2;
            const endY = r.top + 50; // Connect to handle bottom
            
            // Bezier curve
            const cY = Math.max(startY, endY) + 50; // Control point drops down
            
            const d = `M ${startX} ${startY} Q ${(startX+endX)/2} ${cY} ${endX} ${endY}`;
            pathEl.setAttribute('d', d);
        }

        // Init wires
        updateWires();

    </script>
</body>
</html>
