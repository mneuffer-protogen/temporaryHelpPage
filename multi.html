<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Series Battery Rack Simulator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap');

  :root {
    --bg: #0e0f11;
    --surface: #161820;
    --surface2: #1e2029;
    --red: #d32f2f;
    --red-glow: #ef5350;
    --black-term: #1a1a1a;
    --black-term-shine: #2e2e2e;
    --yellow: #fbc02d;
    --yellow-dim: #c49a24;
    --steel: #a8a8a8;
    --steel-light: #d0d0d0;
    --blue-case: #0a4f7a;
    --blue-case-light: #0d6599;
    --text: #c8cad0;
    --text-dim: #6b6e78;
    --accent: #4fc3f7;
    --accent-dim: #1a6a8a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    user-select: none;
    position: relative;
  }

  /* Ambient grid background */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(79,195,247,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(79,195,247,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* ─── HEADER ─── */
  .header {
    position: relative; z-index: 2;
    text-align: center;
    padding: 28px 20px 8px;
  }
  .header h1 {
    font-size: 1.55rem;
    font-weight: 600;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: #fff;
  }
  .header h1 span { color: var(--accent); }
  .header p {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.72rem;
    color: var(--text-dim);
    margin-top: 6px;
    letter-spacing: 1.2px;
  }

  /* ─── MAIN SCENE ─── */
  .scene {
    position: relative; z-index: 2;
    margin-top: 30px;
    display: flex;
    align-items: flex-start;
    gap: 48px;
  }

  /* ─── RACK PLATFORM ─── */
  .rack-platform {
    background: linear-gradient(170deg, #1a1c24 0%, #111318 100%);
    border: 1px solid #2a2d35;
    border-radius: 10px;
    padding: 36px 30px 40px;
    box-shadow:
      0 0 0 1px rgba(79,195,247,0.06),
      0 25px 60px rgba(0,0,0,0.7),
      inset 0 1px 0 rgba(255,255,255,0.04);
    position: relative;
  }

  .rack-label-row {
    display: flex;
    justify-content: space-between;
    padding: 0 4px;
    margin-bottom: 12px;
  }
  .rack-label-row span {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: var(--text-dim);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .rack-row {
    display: flex;
    gap: 18px;
    position: relative;
  }

  /* ─── SVG WIRING LAYER ─── */
  #wiring-svg {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 3;
    overflow: visible;
  }

  /* jumper bar body — main steel face */
  .jumper-body {
    fill: url(#grad-bar);
    stroke: #4a4a4a;
    stroke-width: 1;
  }
  /* top highlight strip on bar */
  .jumper-shine {
    fill: url(#grad-shine);
  }
  /* bolt circles */
  .bolt-ring  { fill: #3a3a3a; stroke: #222; stroke-width: 0.8; }
  .bolt-face  { fill: url(#grad-bolt); }
  .bolt-spec  { fill: rgba(255,255,255,0.55); }

  /* inter-block cable (thick dark rubber) */
  .cable-shadow { stroke: rgba(0,0,0,0.55); stroke-width: 13; stroke-linecap: round; fill: none; }
  .cable-body   { stroke: #1c1c1c;          stroke-width: 10; stroke-linecap: round; fill: none; }
  .cable-shine  { stroke: rgba(255,255,255,0.08); stroke-width: 4;  stroke-linecap: round; fill: none; }

  /* ─── BATTERY BLOCK ─── */
  .bat-block {
    background: linear-gradient(180deg, var(--blue-case) 0%, #073a5c 100%);
    border: 1px solid #0a2a40;
    border-radius: 6px;
    padding: 18px 10px 16px;
    display: flex;
    gap: 12px;
    position: relative;
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.08),
      0 8px 24px rgba(0,0,0,0.45);
  }
  .bat-block::after {
    content: attr(data-label);
    position: absolute;
    bottom: 5px; left: 0; right: 0;
    text-align: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.58rem;
    color: rgba(255,255,255,0.25);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* ─── CELL COLUMN ─── */
  .cell-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    position: relative;
    z-index: 5;
  }

  /* ─── VENT CAP ─── */
  .vent-cap {
    width: 26px; height: 26px;
    border-radius: 50%;
    background: radial-gradient(circle at 38% 35%, var(--yellow) 0%, var(--yellow-dim) 60%, #9a7a1a 100%);
    border: 1.5px solid #a08010;
    box-shadow:
      0 2px 6px rgba(0,0,0,0.4),
      inset 0 1px 2px rgba(255,255,255,0.35);
    position: relative;
  }
  .vent-cap::after {
    content: '';
    position: absolute;
    top: 4px; left: 50%; transform: translateX(-50%);
    width: 10px; height: 2px;
    background: rgba(0,0,0,0.35);
    border-radius: 1px;
  }

  /* ─── TERMINAL ─── */
  .terminal {
    width: 34px; height: 34px;
    border-radius: 50%;
    position: relative;
    cursor: crosshair;
    transition: filter 0.15s;
  }
  .terminal.pos {
    background: radial-gradient(circle at 40% 35%, var(--red-glow), var(--red) 55%, #8b1a1a 100%);
    border: 2px solid #6e1515;
    box-shadow: 0 3px 8px rgba(0,0,0,0.45), inset 0 1px 2px rgba(255,100,100,0.3);
  }
  .terminal.neg {
    background: radial-gradient(circle at 40% 35%, var(--black-term-shine), var(--black-term) 55%, #0a0a0a 100%);
    border: 2px solid #333;
    box-shadow: 0 3px 8px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.08);
  }
  /* Metal post */
  .terminal .post {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 16px; height: 16px;
    border-radius: 50%;
    background: radial-gradient(circle at 40% 35%, #e8e8e8, var(--steel) 60%, #777 100%);
    border: 1px solid #666;
    box-shadow: inset 0 1px 2px rgba(255,255,255,0.6), 0 1px 3px rgba(0,0,0,0.3);
  }
  .terminal:hover { filter: brightness(1.25); }
  .terminal.lit {
    box-shadow: 0 0 14px 3px rgba(79,195,247,0.6), 0 3px 8px rgba(0,0,0,0.4) !important;
  }

  /* Polarity label */
  .pol-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.62rem;
    font-weight: bold;
    line-height: 1;
  }
  .pol-label.pos { color: var(--red-glow); }
  .pol-label.neg { color: var(--steel); }

  /* ─── MULTIMETER ─── */
  .meter-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .meter {
    width: 200px;
    background: linear-gradient(170deg, #ffe082 0%, #f9a825 40%, #f57f17 100%);
    border-radius: 14px;
    border: 3px solid #5d4000;
    box-shadow: 0 12px 40px rgba(0,0,0,0.55), inset 0 2px 0 rgba(255,255,255,0.25);
    padding: 20px 16px 18px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    position: relative;
  }
  .meter-brand {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 3px;
    color: #5d4000;
    text-transform: uppercase;
  }
  .meter-screen {
    width: 100%;
    background: linear-gradient(145deg, #b8c4a0, #a3b08a);
    border: 3px solid #3a3a3a;
    border-radius: 6px;
    padding: 10px 12px;
    box-shadow: inset 2px 2px 6px rgba(0,0,0,0.25);
    position: relative;
    overflow: hidden;
  }
  .meter-screen::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, transparent 50%);
    pointer-events: none;
  }
  .screen-value {
    font-family: 'Share Tech Mono', monospace;
    font-size: 2.2rem;
    font-weight: bold;
    color: #1a1a1a;
    text-align: right;
    position: relative; z-index: 1;
    letter-spacing: -1px;
  }
  .screen-unit {
    font-size: 1rem;
    margin-left: 4px;
    color: #333;
  }
  .screen-mode {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: #4a5a3a;
    text-align: left;
    position: relative; z-index: 1;
    margin-top: 2px;
    letter-spacing: 1px;
  }

  /* Probe jacks */
  .jack-row {
    display: flex;
    justify-content: space-between;
    width: 100%;
    margin-top: 4px;
  }
  .jack {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 2px solid #5d4000;
    display: flex; align-items: center; justify-content: center;
    position: relative;
  }
  .jack.com { background: #2a2a2a; }
  .jack.vw { background: #c62828; }
  .jack-hole {
    width: 10px; height: 10px;
    background: #000;
    border-radius: 50%;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.8);
  }
  .jack-label {
    position: absolute;
    bottom: -14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.55rem;
    color: #5d4000;
    font-weight: bold;
    letter-spacing: 1px;
  }

  /* ─── PROBES ─── */
  .probe {
    position: fixed;
    width: 22px;
    height: 130px;
    z-index: 200;
    cursor: grab;
    filter: drop-shadow(3px 6px 10px rgba(0,0,0,0.5));
  }
  .probe:active { cursor: grabbing; }
  .probe-body {
    width: 100%; height: 82px;
    border-radius: 5px 5px 3px 3px;
    position: absolute; top: 0;
    display: flex; align-items: center; justify-content: center;
  }
  .probe-body .grip-lines {
    width: 70%; height: 60%;
    display: flex; flex-direction: column;
    justify-content: space-around;
  }
  .grip-lines span {
    display: block;
    height: 2px;
    background: rgba(0,0,0,0.2);
    border-radius: 1px;
  }
  .probe.red .probe-body { background: linear-gradient(100deg, #b71c1c, #ef5350 40%, #c62828); }
  .probe.blk .probe-body { background: linear-gradient(100deg, #111, #333 40%, #222); }

  .probe-shaft {
    position: absolute;
    top: 78px; left: 50%;
    transform: translateX(-50%);
    width: 4px; height: 38px;
    border-radius: 2px 2px 1px 1px;
    background: linear-gradient(90deg, #888, #eee 40%, #aaa);
  }
  .probe-tip {
    position: absolute;
    top: 114px; left: 50%;
    transform: translateX(-50%);
    width: 3px; height: 18px;
    background: linear-gradient(90deg, #bbb, #fff 50%, #999);
    clip-path: polygon(30% 0%, 70% 0%, 55% 100%, 45% 100%);
  }

  /* ─── METER WIRES (SVG overlay) ─── */
  #meter-wires-svg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 150;
  }

  /* ─── INFO BAR ─── */
  .info-bar {
    position: relative; z-index: 2;
    margin-top: 28px;
    display: flex;
    gap: 24px;
  }
  .info-chip {
    background: var(--surface);
    border: 1px solid #2a2d35;
    border-radius: 6px;
    padding: 8px 14px;
    display: flex; align-items: center; gap: 8px;
  }
  .info-chip .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
  }
  .dot.green { background: #66bb6a; box-shadow: 0 0 6px #66bb6a; }
  .dot.blue  { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  .info-chip span {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.66rem;
    color: var(--text-dim);
    letter-spacing: 0.8px;
  }
  .info-chip .val { color: var(--text); font-weight: bold; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>Series Battery <span>Rack</span> Simulator</h1>
  <p>DRAG PROBES → TERMINAL POSTS TO MEASURE VOLTAGE</p>
</div>

<!-- Main scene -->
<div class="scene" id="scene">

  <!-- Rack -->
  <div class="rack-platform" id="rack-platform">
    <div class="rack-label-row">
      <span>← HIGH POTENTIAL</span>
      <span>LOW POTENTIAL →</span>
    </div>
    <div class="rack-row" id="rack-row"></div>
    <svg id="wiring-svg"></svg>
  </div>

  <!-- Multimeter -->
  <div class="meter-wrap">
    <div class="meter" id="meter">
      <div class="meter-brand">Fluke 87 V</div>
      <div class="meter-screen">
        <div class="screen-mode">V DC</div>
        <div class="screen-value" id="disp">0.00<span class="screen-unit">V</span></div>
      </div>
      <div class="jack-row">
        <div class="jack com"><div class="jack-hole"></div><div class="jack-label">COM</div></div>
        <div class="jack vw"><div class="jack-hole"></div><div class="jack-label">V Ω</div></div>
      </div>
    </div>
  </div>

</div>

<!-- Info bar -->
<div class="info-bar">
  <div class="info-chip"><div class="dot green"></div><span>CELLS <span class="val" id="info-cells">12</span></span></div>
  <div class="info-chip"><div class="dot blue"></div><span>TOTAL VOLTAGE <span class="val" id="info-total">—</span></div></div>
  <div class="info-chip"><div class="dot green"></div><span>MEASURED <span class="val" id="info-meas">0.00 V</span></span></div>
</div>

<!-- Meter wire SVG (fixed, full viewport) -->
<svg id="meter-wires-svg">
  <defs>
    <filter id="wire-shadow">
      <feDropShadow dx="0" dy="3" stdDeviation="3" flood-opacity="0.4"/>
    </filter>
  </defs>
  <path id="wire-red" stroke="#d32f2f" stroke-width="4.5" fill="none" filter="url(#wire-shadow)" stroke-linecap="round"/>
  <path id="wire-blk" stroke="#333"    stroke-width="4.5" fill="none" filter="url(#wire-shadow)" stroke-linecap="round"/>
</svg>

<!-- Probes (fixed positioned, draggable) -->
<div class="probe red" id="probe-red" style="top:320px;left:680px;">
  <div class="probe-body"><div class="grip-lines"><span></span><span></span><span></span><span></span></div></div>
  <div class="probe-shaft"></div>
  <div class="probe-tip"></div>
</div>
<div class="probe blk" id="probe-blk" style="top:420px;left:780px;">
  <div class="probe-body"><div class="grip-lines"><span></span><span></span><span></span><span></span></div></div>
  <div class="probe-shaft"></div>
  <div class="probe-tip"></div>
</div>

<script>
// ─── CONFIG ─────────────────────────────────────────────
const NUM_BLOCKS   = 4;
const CELLS_BLOCK  = 3;
const V_CELL       = 2.05;
const TOTAL_CELLS  = NUM_BLOCKS * CELLS_BLOCK;   // 12

// ─── BUILD RACK ─────────────────────────────────────────
const rackRow    = document.getElementById('rack-row');
const wiringSvg  = document.getElementById('wiring-svg');

// We store every terminal DOM element keyed by global cell index (0 = leftmost cell)
// globalIndex runs 0..11 left-to-right.
// Electrical potential: cell at globalIndex g has
//   potLow  = (TOTAL_CELLS - 1 - g) * V_CELL
//   potHigh = (TOTAL_CELLS - g)     * V_CELL
// So globalIndex 0 (far left) is highest potential.

let terminalMap = {};  // { globalIdx: { top: el, bot: el } }

for (let b = 0; b < NUM_BLOCKS; b++) {
  const block = document.createElement('div');
  block.className = 'bat-block';
  block.setAttribute('data-label', `Block ${b+1}`);

  for (let c = 0; c < CELLS_BLOCK; c++) {
    const g = b * CELLS_BLOCK + c;           // global cell index
    const elecIdx = TOTAL_CELLS - 1 - g;     // 0 = ground side
    const potLow  = elecIdx * V_CELL;
    const potHigh = (elecIdx + 1) * V_CELL;

    // ── ALTERNATING ORIENTATION ──
    // Every cell flips relative to its neighbour.
    // g even  → top = NEG  (potLow),  bot = POS (potHigh)
    // g odd   → top = POS  (potHigh), bot = NEG (potLow)
    const evenCell = (g % 2 === 0);
    const topType  = evenCell ? 'neg' : 'pos';
    const botType  = evenCell ? 'pos' : 'neg';
    const topVolt  = evenCell ? potLow  : potHigh;
    const botVolt  = evenCell ? potHigh : potLow;

    // Build column
    const col = document.createElement('div');
    col.className = 'cell-col';

    // Vent
    const vent = document.createElement('div');
    vent.className = 'vent-cap';

    // Top label + terminal
    const topLabel = makePolarityLabel(topType);
    const topTerm  = makeTerminal(topType, topVolt);

    // Bottom terminal + label
    const botTerm  = makeTerminal(botType, botVolt);
    const botLabel = makePolarityLabel(botType);

    col.append(vent, topLabel, topTerm, botTerm, botLabel);
    block.append(col);

    terminalMap[g] = { top: topTerm, bot: botTerm };
  }
  rackRow.append(block);
}

function makeTerminal(type, volts) {
  const el = document.createElement('div');
  el.className = 'terminal ' + type;
  el.dataset.volts = volts.toFixed(2);
  const post = document.createElement('div');
  post.className = 'post';
  el.append(post);
  return el;
}
function makePolarityLabel(type) {
  const el = document.createElement('div');
  el.className = 'pol-label ' + type;
  el.textContent = type === 'pos' ? '+' : '−';
  return el;
}

// ─── SVG DEFS (gradients for jumper bars & bolts) ──────
(function() {
  const ns = 'http://www.w3.org/2000/svg';
  const defs = document.createElementNS(ns, 'defs');
  defs.innerHTML = `
    <!-- main bar face: steel grey top-lit -->
    <linearGradient id="grad-bar" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%"   stop-color="#c8c8c8"/>
      <stop offset="30%"  stop-color="#a0a0a0"/>
      <stop offset="70%"  stop-color="#787878"/>
      <stop offset="100%" stop-color="#585858"/>
    </linearGradient>
    <!-- narrow highlight strip across the top edge -->
    <linearGradient id="grad-shine" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%"   stop-color="rgba(255,255,255,0.45)"/>
      <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
    </linearGradient>
    <!-- bolt face radial -->
    <radialGradient id="grad-bolt" cx="38%" cy="35%" r="50%">
      <stop offset="0%"   stop-color="#d8d8d8"/>
      <stop offset="60%"  stop-color="#999"/>
      <stop offset="100%" stop-color="#666"/>
    </radialGradient>
    <!-- drop-shadow filter for the bar -->
    <filter id="bar-shadow" x="-10%" y="-10%" width="120%" height="140%">
      <feDropShadow dx="0" dy="2.5" stdDeviation="2.2" flood-color="#000" flood-opacity="0.55"/>
    </filter>
  `;
  wiringSvg.appendChild(defs);
})();

// ─── DRAW SERIES WIRING ─────────────────────────────────
requestAnimationFrame(drawWiring);

function centerOf(el, svgRect) {
  const r = el.getBoundingClientRect();
  return { x: r.left + r.width/2 - svgRect.left, y: r.top + r.height/2 - svgRect.top };
}

function drawWiring() {
  // Remove everything except <defs>
  [...wiringSvg.children].forEach(ch => { if (ch.tagName !== 'defs') ch.remove(); });

  const svgRect = wiringSvg.getBoundingClientRect();

  for (let g = 0; g < TOTAL_CELLS - 1; g++) {
    const cur  = terminalMap[g];
    const next = terminalMap[g + 1];

    const sharedV  = ((TOTAL_CELLS - 1 - g) * V_CELL).toFixed(2);
    const curTerm  = parseFloat(cur.top.dataset.volts).toFixed(2)  === sharedV ? cur.top  : cur.bot;
    const nextTerm = parseFloat(next.top.dataset.volts).toFixed(2) === sharedV ? next.top : next.bot;

    const sameBlock = Math.floor(g / CELLS_BLOCK) === Math.floor((g+1) / CELLS_BLOCK);
    const p1 = centerOf(curTerm,  svgRect);
    const p2 = centerOf(nextTerm, svgRect);

    if (sameBlock) {
      drawJumperBar(p1, p2);   // flat metal bar
    } else {
      drawCable(p1, p2);       // arched rubber cable
    }
  }
}

// ─── FLAT METAL JUMPER BAR ──────────────────────────────
// Draws a rectangular steel bar connecting two terminal centers,
// with a top-lit gradient, edge highlight, and a bolt at each end.
function drawJumperBar(p1, p2) {
  const ns = 'http://www.w3.org/2000/svg';
  const BAR_H = 11;          // half-height of bar
  const BOLT_R = 5.5;        // bolt circle radius
  const BOLT_SPEC_R = 1.8;   // specular dot

  const dx = p2.x - p1.x;
  const dy = p2.y - p1.y;
  const len = Math.hypot(dx, dy);
  // Unit vector along bar, and perpendicular (rotated 90° CCW)
  const ux = dx / len,  uy = dy / len;
  const px = -uy,       py =  ux;       // perpendicular

  // Four corners of the rectangle (p1 ─── p2 across, ±BAR_H perpendicular)
  const corners = [
    { x: p1.x + px*BAR_H, y: p1.y + py*BAR_H },   // top-left
    { x: p2.x + px*BAR_H, y: p2.y + py*BAR_H },   // top-right
    { x: p2.x - px*BAR_H, y: p2.y - py*BAR_H },   // bot-right
    { x: p1.x - px*BAR_H, y: p1.y - py*BAR_H },   // bot-left
  ];
  const rectD = corners.map((c,i) => (i===0?'M':'L') + c.x.toFixed(2) + ',' + c.y.toFixed(2)).join(' ') + ' Z';

  // Highlight strip: top 30% of bar height
  const SHINE_H = BAR_H * 0.55;
  const shineCorners = [
    corners[0],
    corners[1],
    { x: p2.x + px*SHINE_H, y: p2.y + py*SHINE_H },
    { x: p1.x + px*SHINE_H, y: p1.y + py*SHINE_H },
  ];
  const shineD = shineCorners.map((c,i) => (i===0?'M':'L') + c.x.toFixed(2) + ',' + c.y.toFixed(2)).join(' ') + ' Z';

  // ── group with shadow filter ──
  const g = document.createElementNS(ns, 'g');
  g.setAttribute('filter', 'url(#bar-shadow)');

  // Bar body
  const body = document.createElementNS(ns, 'path');
  body.setAttribute('d', rectD);
  body.setAttribute('class', 'jumper-body');
  g.appendChild(body);

  // Shine overlay
  const shine = document.createElementNS(ns, 'path');
  shine.setAttribute('d', shineD);
  shine.setAttribute('class', 'jumper-shine');
  g.appendChild(shine);

  wiringSvg.appendChild(g);

  // ── bolts (drawn OUTSIDE the shadow group so they sit on top) ──
  [p1, p2].forEach(center => {
    const ring = document.createElementNS(ns, 'circle');
    ring.setAttribute('cx', center.x); ring.setAttribute('cy', center.y);
    ring.setAttribute('r', BOLT_R);
    ring.setAttribute('class', 'bolt-ring');
    wiringSvg.appendChild(ring);

    const face = document.createElementNS(ns, 'circle');
    face.setAttribute('cx', center.x); face.setAttribute('cy', center.y);
    face.setAttribute('r', BOLT_R - 1.2);
    face.setAttribute('class', 'bolt-face');
    wiringSvg.appendChild(face);

    // specular highlight offset upper-left
    const spec = document.createElementNS(ns, 'circle');
    spec.setAttribute('cx', center.x - 1.5); spec.setAttribute('cy', center.y - 1.5);
    spec.setAttribute('r', BOLT_SPEC_R);
    spec.setAttribute('class', 'bolt-spec');
    wiringSvg.appendChild(spec);
  });
}

// ─── ARCHED RUBBER CABLE (inter-block) ──────────────────
function drawCable(p1, p2) {
  const ns   = 'http://www.w3.org/2000/svg';
  const arch = 36;   // how far the arc peaks above the terminals
  const midY = Math.min(p1.y, p2.y) - arch;
  const midX = (p1.x + p2.x) / 2;
  const d    = `M${p1.x},${p1.y} Q${midX},${midY} ${p2.x},${p2.y}`;

  // Shadow
  const shadow = document.createElementNS(ns, 'path');
  shadow.setAttribute('d', d); shadow.setAttribute('class', 'cable-shadow');
  wiringSvg.appendChild(shadow);
  // Body
  const body = document.createElementNS(ns, 'path');
  body.setAttribute('d', d); body.setAttribute('class', 'cable-body');
  wiringSvg.appendChild(body);
  // Shine
  const shine = document.createElementNS(ns, 'path');
  shine.setAttribute('d', d); shine.setAttribute('class', 'cable-shine');
  wiringSvg.appendChild(shine);

  // End-cap bolts (same as jumper bolts)
  [p1, p2].forEach(center => {
    const ring = document.createElementNS(ns, 'circle');
    ring.setAttribute('cx', center.x); ring.setAttribute('cy', center.y);
    ring.setAttribute('r', 5.5); ring.setAttribute('class', 'bolt-ring');
    wiringSvg.appendChild(ring);
    const face = document.createElementNS(ns, 'circle');
    face.setAttribute('cx', center.x); face.setAttribute('cy', center.y);
    face.setAttribute('r', 4.3); face.setAttribute('class', 'bolt-face');
    wiringSvg.appendChild(face);
    const spec = document.createElementNS(ns, 'circle');
    spec.setAttribute('cx', center.x - 1.5); spec.setAttribute('cy', center.y - 1.5);
    spec.setAttribute('r', 1.8); spec.setAttribute('class', 'bolt-spec');
    wiringSvg.appendChild(spec);
  });
}

// ─── INFO BAR ────────────────────────────────────────────
document.getElementById('info-cells').textContent = TOTAL_CELLS;
document.getElementById('info-total').textContent = (TOTAL_CELLS * V_CELL).toFixed(2) + ' V';

// ─── PROBE DRAG & MEASURE ────────────────────────────────
const probeRed = document.getElementById('probe-red');
const probeBlk = document.getElementById('probe-blk');
const wireRedPath = document.getElementById('wire-red');
const wireBlkPath = document.getElementById('wire-blk');
const dispEl     = document.getElementById('disp');
const infoMeas   = document.getElementById('info-meas');

let probes = {
  red: { el: probeRed, val: null },
  blk: { el: probeBlk, val: null }
};

let dragging = null, off = {x:0, y:0};

probeRed.addEventListener('mousedown', e => startDrag(e, probes.red));
probeBlk.addEventListener('mousedown', e => startDrag(e, probes.blk));
probeRed.addEventListener('touchstart', e => startDrag(e.touches[0], probes.red), {passive:false});
probeBlk.addEventListener('touchstart', e => startDrag(e.touches[0], probes.blk), {passive:false});

function startDrag(e, p) {
  e.preventDefault();
  dragging = p;
  const r = p.el.getBoundingClientRect();
  off.x = e.clientX - r.left;
  off.y = e.clientY - r.top;
  document.addEventListener('mousemove', onDrag);
  document.addEventListener('mouseup',   onUp);
  document.addEventListener('touchmove', onTouchDrag, {passive:false});
  document.addEventListener('touchend',  onUp);
}
function onTouchDrag(e) { e.preventDefault(); onDrag(e.touches[0]); }
function onDrag(e) {
  if (!dragging) return;
  dragging.el.style.left = (e.clientX - off.x) + 'px';
  dragging.el.style.top  = (e.clientY - off.y) + 'px';
  hitTest(dragging);
  updateWires();
}
function onUp() {
  dragging = null;
  document.removeEventListener('mousemove', onDrag);
  document.removeEventListener('mouseup',   onUp);
  document.removeEventListener('touchmove', onTouchDrag);
  document.removeEventListener('touchend',  onUp);
}

// Tip hotspot: very bottom-center of the probe element
function tipPos(p) {
  const r = p.el.getBoundingClientRect();
  return { x: r.left + r.width / 2, y: r.bottom };
}

function hitTest(p) {
  const tip = tipPos(p);
  let hit = false;
  document.querySelectorAll('.terminal').forEach(t => {
    const r = t.getBoundingClientRect();
    // Slightly enlarged hit area for usability
    const pad = 4;
    if (tip.x >= r.left-pad && tip.x <= r.right+pad && tip.y >= r.top-pad && tip.y <= r.bottom+pad) {
      hit = true;
      p.val = parseFloat(t.dataset.volts);
      t.classList.add('lit');
    } else {
      t.classList.remove('lit');
    }
  });
  if (!hit) p.val = null;
  updateReading();
}

function updateReading() {
  let label, v;
  if (probes.red.val !== null && probes.blk.val !== null) {
    v = probes.red.val - probes.blk.val;
    label = v.toFixed(2) + '<span class="screen-unit">V</span>';
    infoMeas.textContent = v.toFixed(2) + ' V';
  } else {
    label = '0.00<span class="screen-unit">V</span>';
    infoMeas.textContent = '0.00 V';
  }
  dispEl.innerHTML = label;
}

// ─── METER WIRES ─────────────────────────────────────────
function updateWires() {
  const meter = document.getElementById('meter').getBoundingClientRect();
  // Red wire anchors at V Ω jack (right jack)
  const rJack = { x: meter.right - 32, y: meter.top + meter.height - 40 };
  // Black wire anchors at COM jack (left jack)
  const bJack = { x: meter.left  + 32, y: meter.top + meter.height - 40 };

  drawWire(probes.red.el, rJack, wireRedPath);
  drawWire(probes.blk.el, bJack, wireBlkPath);
}

function drawWire(probeEl, jack, pathEl) {
  const r = probeEl.getBoundingClientRect();
  const px = r.left + r.width / 2;
  const py = r.top;    // top of handle
  // Quadratic bezier with control point between
  const cx = (jack.x + px) / 2;
  const cy = Math.min(jack.y, py) - 60;
  pathEl.setAttribute('d', `M${jack.x},${jack.y} Q${cx},${cy} ${px},${py}`);
}

// Initial wire draw after layout
requestAnimationFrame(() => { updateWires(); });

// Redraw wiring on resize
window.addEventListener('resize', () => { drawWiring(); updateWires(); });
</script>
</body>
</html>
