<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Rack Multimeter Sim</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        h2 { margin-bottom: 10px; color: #ccc; }
        .instructions { color: #888; margin-bottom: 30px; font-size: 0.9em; }

        /* --- RACK CONTAINER --- */
        .rack-container {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        /* --- BATTERY STYLING --- */
        .battery {
            width: 120px;
            height: 160px;
            background: linear-gradient(to bottom, #0055aa 40%, #ddd 40%);
            border-radius: 4px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-around;
            padding-top: 10px;
        }

        .battery::after {
            content: attr(data-label);
            position: absolute;
            bottom: 10px;
            left: 0; 
            width: 100%;
            text-align: center;
            color: #333;
            font-weight: bold;
        }

        /* --- TERMINALS (NODES) --- */
        .terminal {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #444;
            border: 2px solid #777;
            position: relative;
            cursor: crosshair;
            transition: transform 0.1s;
            z-index: 10;
        }

        .terminal.pos { background: #cc0000; border-color: #ff4444; }
        .terminal.neg { background: #111; border-color: #555; }
        
        .terminal:hover { transform: scale(1.2); border-color: white; }

        /* Visual Jumpers (Decoration) */
        .jumper {
            position: absolute;
            height: 12px;
            background: #888;
            border: 1px solid #555;
            z-index: 5;
            top: 20px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }

        /* --- MULTIMETER --- */
        .multimeter {
            margin-top: 40px;
            width: 250px;
            background: #e6b800; /* Fluke Yellow */
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 4px solid #333;
        }

        .screen {
            width: 90%;
            height: 60px;
            background: #9ea792;
            border: 2px solid #555;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 32px;
            color: #111;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        /* --- PROBES --- */
        .probe-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }

        .probe {
            width: 20px;
            height: 100px;
            position: absolute; /* Allows dragging */
            cursor: grab;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.5));
        }

        .probe:active { cursor: grabbing; }

        .probe-tip {
            width: 4px;
            height: 30px;
            background: silver;
            border-radius: 2px;
        }

        .probe-handle {
            width: 18px;
            height: 70px;
            border-radius: 4px;
        }

        .probe-red .probe-handle { background: #cc0000; }
        .probe-black .probe-handle { background: #111; }

        /* Wire simulation (SVG lines) */
        svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 999;
        }
    </style>
</head>
<body>

    <h2>Series Battery Rack Simulation</h2>
    <div class="instructions">Drag the probes to terminals. Readings are based on Node Potential relative to Ground (Bat 4 Neg).</div>

    <div class="rack-container" id="rack">
        <div class="jumper" style="left: 105px; width: 50px;"></div>
        <div class="jumper" style="left: 235px; width: 50px;"></div>
        <div class="jumper" style="left: 365px; width: 50px;"></div>

        <div class="battery" data-label="Bat 1">
            <div class="terminal pos" data-potential="24.60" title="System Pos (+)"></div>
            <div class="terminal neg" data-potential="18.45" title="Bat 1 Neg"></div>
        </div>

        <div class="battery" data-label="Bat 2">
            <div class="terminal pos" data-potential="18.45" title="Bat 2 Pos"></div>
            <div class="terminal neg" data-potential="12.30" title="Bat 2 Neg"></div>
        </div>

        <div class="battery" data-label="Bat 3">
            <div class="terminal pos" data-potential="12.30" title="Bat 3 Pos"></div>
            <div class="terminal neg" data-potential="6.15" title="Bat 3 Neg"></div>
        </div>

        <div class="battery" data-label="Bat 4">
            <div class="terminal pos" data-potential="6.15" title="Bat 4 Pos"></div>
            <div class="terminal neg" data-potential="0.00" title="System Gnd (-)"></div>
        </div>
    </div>

    <div class="multimeter">
        <div class="screen" id="display">0.00 V</div>
        <div class="probe-home" style="height: 100px; width: 100%;">
            </div>
    </div>

    <div id="probe-red" class="probe probe-red" style="top: 450px; left: calc(50% + 20px);">
        <div class="probe-tip"></div>
        <div class="probe-handle"></div>
    </div>

    <div id="probe-black" class="probe probe-black" style="top: 450px; left: calc(50% - 40px);">
        <div class="probe-tip"></div>
        <div class="probe-handle"></div>
    </div>

    <svg>
        <line id="wire-red" x1="0" y1="0" x2="0" y2="0" stroke="#cc0000" stroke-width="3" />
        <line id="wire-black" x1="0" y1="0" x2="0" y2="0" stroke="#333" stroke-width="3" />
    </svg>

    <script>
        // State
        const probes = {
            red: { el: document.getElementById('probe-red'), x: 0, y: 0, potential: null },
            black: { el: document.getElementById('probe-black'), x: 0, y: 0, potential: null }
        };
        
        const display = document.getElementById('display');
        const wireRed = document.getElementById('wire-red');
        const wireBlack = document.getElementById('wire-black');
        const meterRect = document.querySelector('.multimeter').getBoundingClientRect();
        
        // Meter anchor points for wires (bottom of the multimeter)
        const meterAnchors = {
            red: { x: meterRect.left + 180, y: meterRect.bottom - 20 },
            black: { x: meterRect.left + 70, y: meterRect.bottom - 20 }
        };

        // Initialize Probes
        let activeProbe = null;
        let offset = { x: 0, y: 0 };

        function init() {
            // Set initial wire positions
            updateWires();
            
            // Add listeners
            addDragLogic(probes.red.el, 'red');
            addDragLogic(probes.black.el, 'black');
        }

        function addDragLogic(element, type) {
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('touchstart', startDrag, {passive: false});

            function startDrag(e) {
                e.preventDefault();
                activeProbe = type;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const rect = element.getBoundingClientRect();
                offset.x = clientX - rect.left;
                offset.y = clientY - rect.top;

                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag, {passive: false});
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
            }
        }

        function drag(e) {
            if (!activeProbe) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const x = clientX - offset.x;
            const y = clientY - offset.y;

            const el = probes[activeProbe].el;
            el.style.left = x + 'px';
            el.style.top = y + 'px';

            // Check for collision with terminals
            checkConnection(activeProbe, x, y);
            updateWires();
        }

        function endDrag() {
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
            activeProbe = null;
        }

        function checkConnection(type, x, y) {
            // Probe tip is at the bottom-center of the dragged element logic 
            // visually top of div is top of tip. Wait, in CSS tip is top child.
            // Let's get the absolute position of the "tip" element
            const probeEl = probes[type].el;
            const tipRect = probeEl.querySelector('.probe-tip').getBoundingClientRect();
            
            // "Hotspot" is the center of the tip
            const tipX = tipRect.left + tipRect.width / 2;
            const tipY = tipRect.top + tipRect.height / 2;

            const terminals = document.querySelectorAll('.terminal');
            let connected = false;

            terminals.forEach(term => {
                const rect = term.getBoundingClientRect();
                // Simple collision detection (if tip is inside terminal box)
                if (tipX >= rect.left && tipX <= rect.right &&
                    tipY >= rect.top && tipY <= rect.bottom) {
                    
                    probes[type].potential = parseFloat(term.getAttribute('data-potential'));
                    connected = true;
                    
                    // Visual feedback
                    term.style.borderColor = "#fff";
                    term.style.boxShadow = "0 0 10px white";
                } else {
                    // Reset style
                    if(term.classList.contains('pos')) {
                        term.style.borderColor = "#ff4444";
                    } else {
                        term.style.borderColor = "#555";
                    }
                    term.style.boxShadow = "none";
                }
            });

            if (!connected) {
                probes[type].potential = null;
            }

            updateDisplay();
        }

        function updateDisplay() {
            const pRed = probes.red.potential;
            const pBlack = probes.black.potential;

            if (pRed !== null && pBlack !== null) {
                let val = pRed - pBlack;
                // Format to 2 decimals
                display.innerText = val.toFixed(2) + " V";
            } else {
                display.innerText = "0.00 V";
            }
        }

        function updateWires() {
            // Draw line from meter anchor to probe handle bottom
            drawWire(probes.red.el, meterAnchors.red, wireRed);
            drawWire(probes.black.el, meterAnchors.black, wireBlack);
        }

        function drawWire(probeEl, anchor, lineEl) {
            const rect = probeEl.getBoundingClientRect();
            // Connect to bottom of handle
            const x2 = rect.left + rect.width / 2;
            const y2 = rect.bottom - 10; 

            lineEl.setAttribute('x1', anchor.x);
            lineEl.setAttribute('y1', anchor.y);
            lineEl.setAttribute('x2', x2);
            lineEl.setAttribute('y2', y2);
        }

        // Run init
        init();

    </script>
</body>
</html>
