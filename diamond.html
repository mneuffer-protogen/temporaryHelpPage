<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>three.js Gemstone</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; background: #fff; color: #111; font-family: sans-serif; }
    #app { position: fixed; inset: 0; }
    #ui {
      position: fixed; top: 16px; left: 16px; z-index: 10;
      background: rgba(255,255,255,.85); backdrop-filter: blur(8px);
      border: 1px solid rgba(0,0,0,.08); border-radius: 12px; padding: 12px 14px; min-width: 240px;
      box-shadow: 0 8px 24px rgba(0,0,0,.08);
    }
    #ui h3 { margin: 0 0 8px 0; font-size: 14px; font-weight: 600; }
    #ui label { display: block; font-size: 12px; opacity: .8; margin: 10px 0 4px; }
    #ui select, #ui input[type="range"] {
      width: 100%; border-radius: 8px; border: 1px solid rgba(0,0,0,.15);
      padding: 6px 10px; background: rgba(255,255,255,.9); font-size: 13px;
    }
    #ui .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    #readout { margin-top: 6px; font-size: 12px; opacity: .85; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background: #f3f4f6; font-size: 11px; margin-left: 6px; }
    #hint { position: fixed; right: 16px; bottom: 16px; z-index: 10; font-size: 12px; opacity: .6; }
  </style>
</head>
<body>
  <div id="app"></div>

  <div id="ui">
    <h3>Gemstone <span class="pill" id="gemNamePill">Diamond</span></h3>
    <label for="gemSelect">Preset</label>
    <select id="gemSelect">
      <option>Diamond</option>
      <option>Ruby</option>
      <option>Sapphire</option>
      <option>Emerald</option>
      <option>Amethyst</option>
      <option>Aquamarine</option>
      <option>Citrine</option>
      <option>Topaz</option>
      <option>Peridot</option>
    </select>

    <label for="rotate">Auto-rotate</label>
    <div class="row">
      <input id="rotate" type="range" min="0" max="1" step="1" value="1">
      <span id="rotateVal" style="font-size:12px; opacity:.7;">on</span>
    </div>

    <label for="exposure">Exposure</label>
    <input id="exposure" type="range" min="0.5" max="2.25" step="0.01" value="1.15" />

    <div id="readout">
      <div><strong>IOR</strong>: <span id="lblIor">2.417</span></div>
      <div><strong>Attenuation</strong>: <span id="lblAttn">∞</span></div>
      <div><strong>Roughness</strong>: <span id="lblR">0.02</span></div>
    </div>
  </div>

  <div id="hint">Drag to orbit • Scroll to zoom • Double-tap to focus</div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.165.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.165.0/examples/jsm/controls/OrbitControls.js';

    const container = document.getElementById('app');
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.15;
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    container.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    const camera = new THREE.PerspectiveCamera(35, innerWidth / innerHeight, 0.1, 100);
    camera.position.set(3, 2, 4);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0, 0.6, 0);

    // ---- Environment texture ----
    const pmrem = new THREE.PMREMGenerator(renderer);
    const texLoader = new THREE.TextureLoader();
    texLoader.load(
      'https://threejs.org/examples/textures/2294472375_24a3b8ef46_o.jpg',
      (texture) => {
        const envMap = pmrem.fromEquirectangular(texture).texture;
        scene.environment = envMap;
        texture.dispose();
      }
    );

    // Floor (shadow catcher)
    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(20, 20),
      new THREE.ShadowMaterial({ opacity: 0.08 })
    );
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // ---- Gem geometry ----
    const gemGeo = new THREE.OctahedronGeometry(0.8, 0);
    gemGeo.scale(1.0, 1.18, 0.98);
    gemGeo.computeVertexNormals();
    gemGeo.computeBoundingBox();
    const thickness = gemGeo.boundingBox.max.y - gemGeo.boundingBox.min.y;

    const gemMat = new THREE.MeshPhysicalMaterial({
      color: 0xffffff,
      metalness: 0.0,
      roughness: 0.02,
      transmission: 1.0,
      transparent: true,
      ior: 2.417,
      thickness: thickness * 1.05,
      attenuationColor: new THREE.Color(0xffffff),
      attenuationDistance: Infinity,
      envMapIntensity: 1.5
    });

    const gem = new THREE.Mesh(gemGeo, gemMat);
    gem.position.y = 0.8;
    gem.castShadow = true;
    scene.add(gem);

    // ---- Lighting ----
    const light = new THREE.SpotLight(0xffffff, 2000, 0, Math.PI/6, 0.2);
    light.position.set(5, 5, 5);
    light.castShadow = true;
    light.shadow.mapSize.set(1024,1024);
    scene.add(light);
    scene.add(light.target);

    scene.add(new THREE.AmbientLight(0xffffff, 0.2));

    // ---- Presets ----
    const GEMS = {
      Diamond:   { ior: 2.417, attnColor: 0xffffff, attnDist: Infinity, rough: 0.02 },
      Ruby:      { ior: 1.77,  attnColor: 0x9b0000, attnDist: 0.45,     rough: 0.03 },
      Sapphire:  { ior: 1.77,  attnColor: 0x2248ff, attnDist: 0.55,     rough: 0.03 },
      Emerald:   { ior: 1.58,  attnColor: 0x1fae5b, attnDist: 0.38,     rough: 0.025 },
      Amethyst:  { ior: 1.54,  attnColor: 0x8a5ecf, attnDist: 0.60,     rough: 0.03 },
      Aquamarine:{ ior: 1.58,  attnColor: 0x7cc7e8, attnDist: 0.80,     rough: 0.02 },
      Citrine:   { ior: 1.54,  attnColor: 0xffc23a, attnDist: 0.65,     rough: 0.028 },
      Topaz:     { ior: 1.62,  attnColor: 0xf4d7a1, attnDist: 0.70,     rough: 0.028 },
      Peridot:   { ior: 1.66,  attnColor: 0x9ec23b, attnDist: 0.52,     rough: 0.027 }
    };

    const gemSelect   = document.getElementById('gemSelect');
    const gemNamePill = document.getElementById('gemNamePill');
    const lblIor      = document.getElementById('lblIor');
    const lblAttn     = document.getElementById('lblAttn');
    const lblR        = document.getElementById('lblR');
    const exposureInp = document.getElementById('exposure');
    const rotateInp   = document.getElementById('rotate');
    const rotateVal   = document.getElementById('rotateVal');

    function applyPreset(name) {
      const p = GEMS[name];
      gemMat.ior = p.ior;
      gemMat.roughness = p.rough;
      gemMat.attenuationColor.setHex(p.attnColor);
      gemMat.attenuationDistance = p.attnDist;
      gemMat.needsUpdate = true;

      gemNamePill.textContent = name;
      lblIor.textContent = p.ior.toFixed(3);
      lblR.textContent = p.rough.toFixed(3);
      lblAttn.textContent = Number.isFinite(p.attnDist) ? (p.attnDist.toFixed(2) + ' m') : '∞';
    }

    gemSelect.addEventListener('change', e => applyPreset(e.target.value));
    exposureInp.addEventListener('input', e => {
      renderer.toneMappingExposure = parseFloat(e.target.value);
    });
    rotateInp.addEventListener('input', e => {
      rotateVal.textContent = (parseInt(e.target.value) === 1) ? 'on' : 'off';
    });

    applyPreset('Diamond');

    // ---- Render loop ----
    const clock = new THREE.Clock();
    function animate() {
      const dt = clock.getDelta();
      if (parseInt(rotateInp.value) === 1) {
        gem.rotation.y += dt * 0.4;
        gem.rotation.x = Math.sin(clock.elapsedTime * 0.25) * 0.08;
      }
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>